# ETL with varied messages for testing merger logic.
# Produces multiple batches of telemetry so the same VIN gets several messages with
# different values/received_at â€” you can verify "latest wins" in the compacted topic.
#
# Run: BENTO_CONFIG=./config/pipeline_etl_varied.yaml go run .
# Then run the log_compacted pipeline and check compacted topic + logs.
#
# Tips: Delete ./data/telemetry.csv before a run for a clean slate; ensure Kafka is up.
input:
  generate:
    # count: 6
    interval: "10s"
    mapping: 'root = {}'

pipeline:
  processors:
    - csv_generator:
        file_path: "./data/telemetry.csv"
        records_per_tick: 800
        bulk_buffer_bytes: 33554432
        num_vincodes: 10
        resource_map_path: "./config/resource_matrix.json"
        seed: 0
        truncate_before_write: true

    - csv_reader:
        file_path: "./data/telemetry.csv"
        batch_size: 50000
        max_lines: 2000

    - telemetry_aggregator:
        resource_matrix_path: "config/resource_matrix.json"

    - kafka_message_builder: {}

output:
  kafka_franz:
    seed_brokers:
      - localhost:19091
      - localhost:19092
      - localhost:19093
    topic: sensor-service.dispatch.telemetry-aggregated
    client_id: bento_etl_varied
    key: ${! meta("vincode") }
